<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>talibalazoo | الاشتراك</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Cairo',sans-serif;}
body{background:#f0f2f5;color:#333;transition: background 0.3s,color 0.3s;}
.hidden{display:none;}
.container{max-width:500px;margin:30px auto;padding:25px;background:#fff;border-radius:15px;box-shadow:0 8px 25px rgba(0,0,0,0.1);animation:fadeIn 0.6s;}
h2{text-align:center;margin-bottom:20px;color:#555;}
input{width:100%;padding:12px;margin:12px 0;border:1px solid #ccc;border-radius:8px;font-size:16px;transition:border 0.3s;}
input:focus{border:1px solid #4CAF50;outline:none;}
button{width:100%;padding:12px;background:#4CAF50;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:16px;transition: background 0.3s, transform 0.2s;}
button:hover{background:#45a049;transform:scale(1.03);}
.channels,.settings,.player{padding:20px;max-width:700px;margin:20px auto;background:#fff;border-radius:15px;box-shadow:0 8px 25px rgba(0,0,0,0.1);animation:fadeIn 0.6s;}
.channel-item{padding:15px;margin:10px 0;background: linear-gradient(90deg,#6a11cb,#2575fc);border-radius:10px;text-align:center;color:#fff;font-weight:bold;font-size:20px;cursor:pointer;transition: transform 0.3s, box-shadow 0.3s;}
.channel-item:hover{transform: scale(1.05);box-shadow:0 5px 20px rgba(0,0,0,0.2);}
.footer{text-align:center;margin-top:20px;font-size:14px;color:#888;}
.theme-btn{padding:10px 20px;margin:10px 0;cursor:pointer;border-radius:5px;border:none;background:#555;color:#fff;transition: background 0.3s;}
.theme-btn:hover{background:#444;}
#player video{width:100%;border-radius:10px;margin-top:15px;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.5.8/hls.min.js"></script>
</head>
<body oncontextmenu="return false;" onselectstart="return false;">

<div id="subscription" class="container">
  <h2>تفعيل الاشتراك</h2>
  <input type="text" id="serial" placeholder="السيريال سيتم توليده هنا" readonly>
  <input type="text" id="code" placeholder="أدخل كود التفعيل">
  <button onclick="activateSubscription()">تفعيل الاشتراك</button>
  <div id="message" style="color:red;margin-top:10px;"></div>
  <div class="footer">© talibalazoo</div>
</div>

<div id="channels" class="channels hidden">
  <h2>القنوات الرياضية</h2>
  <div id="channelList"></div>
  <button class="theme-btn" onclick="openSettings()">الإعدادات</button>
  <div class="footer">© talibalazoo</div>
</div>

<div id="player" class="player hidden">
  <h2 id="channelTitle"></h2>
  <video id="channelVideo" controls autoplay></video>
  <button class="theme-btn" onclick="backToChannels()">عودة للقنوات</button>
  <div class="footer">© talibalazoo</div>
</div>

<div id="settings" class="settings hidden">
  <h2>الإعدادات</h2>
  <button class="theme-btn" onclick="changeColor('#f0f2f5','#333')">الوضع الافتراضي</button>
  <button class="theme-btn" onclick="changeColor('#222','#fff')">الوضع الليلي</button>
  <div style="margin-top:20px;">
    <h3>معلومات الاشتراك:</h3>
    <p id="subInfo"></p>
  </div>
  <button class="theme-btn" onclick="backToChannels()">عودة للقنوات</button>
  <div class="footer">© talibalazoo</div>
</div>

<script>
let activeSerial = '';
let serialKey = 'deviceSerial';
let hls; // متغير لحفظ مثيل HLS.js

// توليد سيريال ثابت لكل جهاز
function getSerial(){
  let serial = localStorage.getItem(serialKey);
  if(!serial){
    serial = 'S-' + Math.random().toString(36).substring(2,10).toUpperCase();
    localStorage.setItem(serialKey, serial);
  }
  return serial;
}

// عند تحميل الصفحة
window.onload = function(){
  const serial = getSerial();
  document.getElementById('serial').value = serial;

  // التعبئة التلقائية للكود إذا كان مفعل مسبقًا
  if(localStorage.getItem('activated') === 'true' && localStorage.getItem('code')){
    document.getElementById('code').value = localStorage.getItem('code');
  }

  // دائماً أظهر واجهة الاشتراك عند الدخول للموقع
  document.getElementById('subscription').classList.remove('hidden');
  document.getElementById('channels').classList.add('hidden');
  document.getElementById('player').classList.add('hidden');
  document.getElementById('settings').classList.add('hidden');
}

// توليد قائمة القنوات
const channelData = [
  {name:'shark 1', src:'https://shls-live-enc.edgenextcdn.net/out/v1/948c54279b594944adde578c95f1d7d1/index.m3u8'},
  {name:'shark 2', src:'https://1.abcdjklaksnj.sbs/hls/1/stream.m3u8'},
  {name:'shark 3', src:'video3.mp4'},
  {name:'shark 4', src:'video4.mp4'},
  {name:'shark 5', src:'video5.mp4'},
  {name:'shark 6', src:'video6.mp4'},
  {name:'shark 7', src:'video7.mp4'},
  {name:'shark 8', src:'video8.mp4'},
  {name:'shark 9', src:'video9.mp4'},
  {name:'shark 10', src:'video10.mp4'}
];

function loadChannels(){
  const list = document.getElementById('channelList');
  list.innerHTML='';
  channelData.forEach(ch=>{
    const div = document.createElement('div');
    div.className='channel-item';
    div.textContent=ch.name;
    div.onclick=()=>openChannel(ch.name,ch.src);
    list.appendChild(div);
  });
}

// فتح واجهة القناة مع معالجة روابط HLS.js
function openChannel(name, src){
  document.getElementById('channels').classList.add('hidden');
  document.getElementById('player').classList.remove('hidden');
  document.getElementById('channelTitle').textContent = name;
  const video = document.getElementById('channelVideo');
  const messageElement = document.getElementById('message');
  messageElement.textContent = ''; // مسح أي رسائل سابقة

  // إيقاف المشغل السابق إذا كان موجودًا
  if (hls) {
    hls.destroy();
    if (video.src) video.src = "";
  }
  
  // التحقق من نوع الرابط
  if (src.endsWith('.m3u8') && Hls.isSupported()) {
    hls = new Hls();
    hls.loadSource(src);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, function() {
      video.play();
    });
    // إضافة معالجة الأخطاء
    hls.on(Hls.Events.ERROR, function (event, data) {
      if (data.fatal) {
        messageElement.textContent = `خطأ في تشغيل القناة: ${data.details}`;
        messageElement.style.color = 'red';
        console.error('Fatal HLS.js error:', data.details);
      }
    });
  } else {
    // تشغيل الفيديو بالطريقة التقليدية
    video.src = src;
    video.play();
  }
}

// العودة للقنوات
function backToChannels(){
  document.getElementById('player').classList.add('hidden');
  document.getElementById('settings').classList.add('hidden');
  document.getElementById('channels').classList.remove('hidden');
  
  // إيقاف المشغل الحالي عند العودة
  const video = document.getElementById('channelVideo');
  video.pause();
  if (hls) {
    hls.destroy();
    hls = null;
  }
}

// فتح الإعدادات
function openSettings(){
  document.getElementById('channels').classList.add('hidden');
  document.getElementById('settings').classList.remove('hidden');
}

// تغيير اللون / الوضع الليلي
function changeColor(bg, color){
  document.body.style.background=bg;
  document.body.style.color=color;
}

// تفعيل الاشتراك عبر Google Apps Script
function activateSubscription(){
  const serial = document.getElementById('serial').value.trim();
  const code = document.getElementById('code').value.trim();
  const message = document.getElementById('message');

  if(!code){ message.textContent='يرجى إدخال كود التفعيل'; return; }

  const url = `https://script.google.com/macros/s/AKfycbw6UZ0bjrhOzVhkXGPixLZ5AE3dlW6sDqgiWypaSV_aLthEXbqUdLKo3gVYUBXpLgDhtQ/exec?serial=${encodeURIComponent(serial)}&code=${encodeURIComponent(code)}`;

  fetch(url)
  .then(res=>res.json())
  .then(data=>{
    if(data.status==='success'){
      activeSerial = serial;
      localStorage.setItem('activated','true'); // حفظ التفعيل
      localStorage.setItem('code', code); // حفظ الكود المفعّل
      message.style.color='green';
      message.textContent='تم التفعيل بنجاح!';

      // اخفاء الاشتراك مؤقتًا وعرض القنوات
      document.getElementById('subscription').classList.add('hidden');
      document.getElementById('channels').classList.remove('hidden');
      loadChannels();
      document.getElementById('subInfo').textContent = `سيريال مفعل: ${serial}`;

    } else {
      message.style.color='red';
      message.textContent = 'الكود غير صحيح أو لم يتم تفعيله بعد';
    }
  })
  .catch(err=>{
    message.style.color='red';
    message.textContent = 'خطأ في الاتصال بالخادم';
  });
}
</script>
</body>
</html>
