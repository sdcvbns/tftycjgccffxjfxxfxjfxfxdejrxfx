<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة إدارة محل مبيعات</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.47.0/tabler-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <style>
    :root{
      --bg:#0f172a;
      --bg-soft:#111827;
      --panel:#0b1220;
      --card:#0f1a2b;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --brand:#22d3ee;
      --brand-2:#a78bfa;
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;
    }
    .theme-light{
      --bg:#f8fafc;
      --bg-soft:#f1f5f9;
      --panel:#e2e8f0;
      --card:#f8fafc;
      --muted:#64748b;
      --text:#1e293b;
      --brand:#0ea5e9;
      --brand-2:#6366f1;
      --danger:#dc2626;
      --ok:#16a34a;
      --warn:#ca8a04;
    }
    .theme-blue-sky{ --brand:#0ea5e9; --brand-2:#6366f1; }
    .theme-green-leaf{ --brand:#4ade80; --brand-2:#22c55e; }
    .theme-orange-fire{ --brand:#fb923c; --brand-2:#f97316; }
    .font-cairo { font-family:"Cairo", system-ui, sans-serif; }
    .font-almarai { font-family: 'Almarai', sans-serif; }
    .font-amiri { font-family: 'Amiri', serif; }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(135deg,var(--bg),#020617 60%);
      color:var(--text); font-family:"Cairo", system-ui, sans-serif; overflow:hidden;
      background-color: var(--custom-bg-color, transparent);
    }
    a{color:inherit}
    .app{display:flex; height:100%;}
    .sidebar{
      width:280px; background:linear-gradient(180deg,#0b1220,var(--panel));
      border-left:1px solid #1f2937; padding:18px; overflow:auto;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.5px; font-size:20px;}
    .brand i{color:var(--brand)}
    .nav{margin-top:18px; display:grid; gap:8px}
    .nav button{
      all:unset; display:flex; gap:10px; align-items:center; padding:12px 14px;
      border:1px solid #1f2937; background:rgba(255,255,255,.02);
      border-radius:14px; cursor:pointer; transition:.2s ease; font-weight:600;
    }
    .nav button:hover{background:rgba(255,255,255,.06)}
    .nav button.active{border-color:var(--brand); box-shadow:0 0 0 2px rgba(34,211,238,.15) inset}
    .logout{margin-top:12px;}

    .main{flex:1; overflow:auto; padding:18px}
    .topbar{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:14px}
    .search{display:flex; gap:10px; align-items:center; background:rgba(255,255,255,.04); border:1px solid #1f2937; padding:8px 12px; border-radius:12px; min-width:320px}
    .search input{all:unset; direction:rtl; width:100%}

    .grid{display:grid; gap:12px}
    .grid.cards{grid-template-columns:repeat(4,minmax(0,1fr))}
    .card{background:linear-gradient(180deg,#0f1a2b,#0b1220); border:1px solid #1f2937; border-radius:18px; padding:14px}
    .card h3{margin:0 0 8px 0; font-size:14px; color:var(--muted); font-weight:600}
    .metric{font-size:28px; font-weight:800}

    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    .btn{all:unset; display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; cursor:pointer; border:1px solid #1f2937; background:rgba(255,255,255,.04); font-weight:700}
    .btn:hover{background:rgba(255,255,255,.08)}
    .btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand-2)); color:#06111a}
    .btn.danger{border-color:#7f1d1d; background:rgba(239,68,68,.1); color:#fecaca}
    .btn.warn{border-color:#7c2d12; background:rgba(245,158,11,.1); color:#fde68a}
    .btn.ok{border-color:#064e3b; background:rgba(34,197,94,.1); color:#bbf7d0}

    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    thead th{font-size:12px; color:var(--muted); text-align:right}
    tbody td{background:rgba(255,255,255,.03); border:1px solid #1f2937; padding:10px; vertical-align:middle}
    tbody tr td:first-child{border-radius:10px 0 0 10px}
    tbody tr td:last-child{border-radius:0 10px 10px 0}

    .split{display:grid; grid-template-columns:1.2fr .8fr; gap:12px}
    .field{display:grid; gap:6px}
    .field input,.field select,.field textarea{all:unset; background:rgba(255,255,255,.04); border:1px solid #1f2937; border-radius:10px; padding:10px; direction:rtl}
    .field textarea{min-height:80px}

    .hidden{display:none !important}

    /* صفحة تسجيل الدخول */
    .login{position:fixed; inset:0; display:grid; place-items:center;
      background:radial-gradient(1200px 800px at 70% -10%, rgba(34,211,238,.15), transparent),
                 linear-gradient(135deg,#020617 10%, #0b1220 90%)}
    .login .panel{width:min(480px,92vw); background:linear-gradient(180deg,#0f1a2b,#0b1220);
      border:1px solid #1f2937; border-radius:20px; padding:18px}
    .login h1{margin:0 0 8px 0}
    .muted{color:var(--muted); font-size:12px}

    .badge{display:inline-flex; gap:6px; align-items:center; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #1f2937; background:rgba(255,255,255,.05)}

    .search-results{
      position: absolute;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background-color: var(--bg-soft);
      border: 1px solid #1f2937;
      border-radius: 10px;
      z-index: 10;
      margin-top: 5px;
    }
    .search-results button {
      all: unset;
      width: 100%;
      padding: 10px;
      cursor: pointer;
      display: block;
      transition: background-color 0.2s ease;
      text-align: right;
    }
    .search-results button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    @media (max-width:1100px){
      .grid.cards{grid-template-columns:repeat(2,minmax(0,1fr))}
      .split{grid-template-columns:1fr}
    }
    @media (max-width:720px){
      .sidebar{position:fixed; z-index:40; inset-block:0; right:0; transform:translateX(100%); transition:.25s}
      .sidebar.open{transform:none}
      .overlay{position:fixed; inset:0; background:rgba(0,0,0,.3); z-index:30}
      .grid.cards{grid-template-columns:1fr}
      body{overflow:auto}
    }

    @media print {
      body * { visibility: hidden; }
      #invoice-print-area, #invoice-print-area * { visibility: visible; }
      #invoice-print-area { position: absolute; left: 0; top: 0; }
    }
  </style>
</head>
<body>
<div id="overlay" class="overlay hidden" onclick="toggleSide(false)"></div>
<div class="app">
  <aside id="sidebar" class="sidebar">
    <div class="brand"><i class="ti ti-shopping-bag"></i><span id="brandName">لوحة المتجر</span></div>
    <div class="nav">
      <button data-page="dashboard" class="active"><i class="ti ti-home"></i>الرئيسية</button>
      <button data-page="products"><i class="ti ti-package"></i>المنتجات</button>
      <button data-page="sales"><i class="ti ti-receipt"></i>المبيعات</button>
      <button data-page="expenses"><i class="ti ti-cash"></i>المصاريف</button>
      <button data-page="analytics"><i class="ti ti-chart-pie"></i>التحليلات</button>
      <button data-page="barcode"><i class="ti ti-barcode"></i>الباركود</button>
      <button data-page="settings"><i class="ti ti-settings"></i>الإعدادات</button>
      <div class="logout">
        <button class="btn" onclick="logout()"><i class="ti ti-logout"></i> خروج</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="toolbar">
        <button class="btn" onclick="toggleSide(true)"><i class="ti ti-layout-sidebar-right"></i><span>القائمة</span></button>
        <span class="badge"><i class="ti ti-shield-check"></i> حالة الدخول: <b id="loginState">—</b></span>
      </div>
      <div class="search">
        <i class="ti ti-search"></i>
        <input id="globalSearch" placeholder="ابحث..." oninput="globalSearch()" />
      </div>
    </div>

    <div id="pages">
        <div id="dashboard" class="page active">
            <h2>فاتورة جديدة</h2>
            <div class="grid cards" style="grid-template-columns: repeat(2, 1fr);">
                <div class="card">
                    <h3>دخل اليوم</h3>
                    <div class="metric" id="dailyIncomeMetric">0</div>
                    <span class="muted">${db.settings.currency}</span>
                </div>
                <div class="card">
                    <h3>دخل الأسبوع</h3>
                    <div class="metric" id="weeklyIncomeMetric">0</div>
                    <span class="muted">${db.settings.currency}</span>
                </div>
            </div>
            <div class="grid" style="margin-top: 12px;">
                <div class="card" style="grid-column: span 2;">
                    <h3>تفاصيل الفاتورة</h3>
                    <div class="grid cards" style="grid-template-columns: 1fr 1fr;">
                        <div class="field">
                            <label>اسم العميل</label>
                            <input id="customerName" placeholder="العميل النقدي" />
                        </div>
                        <div class="field">
                            <label>رقم الفاتورة</label>
                            <input id="invoiceNumber" value="" readonly />
                        </div>
                    </div>
                    <div class="field" style="margin-top: 12px; position: relative;">
                        <label>ابحث عن منتج بالاسم أو الباركود</label>
                        <input id="productSearch" oninput="searchProduct(this.value)" placeholder="اسم المنتج أو الباركود" />
                        <div id="searchResults" class="search-results hidden"></div>
                    </div>
                </div>
                <div class="card">
                    <h3>ملخص الفاتورة</h3>
                    <div class="grid" style="gap: 8px;">
                        <div class="badge">
                            <b>الإجمالي:</b>
                            <span id="totalAmount">0</span>
                            <span>IQD</span>
                        </div>
                        <div class="badge">
                            <b>الخصم:</b>
                            <input type="number" id="discount" value="0" style="width: 50px; text-align: center; background: none; border: none; color: white;" oninput="updateTotals()">
                            <span>%</span>
                        </div>
                        <div class="badge">
                            <b>الإجمالي بعد الخصم:</b>
                            <span id="finalTotal">0</span>
                            <span>IQD</span>
                        </div>
                    </div>
                    <div class="toolbar" style="margin-top: 12px;">
                        <button class="btn primary" onclick="payAndPrint()"><i class="ti ti-cash"></i> دفع</button>
                        <button class="btn danger" onclick="clearInvoice()"><i class="ti ti-trash"></i> إفراغ</button>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 12px;">
                <h3>قائمة المنتجات</h3>
                <div class="invoice-items" id="invoiceItems">
                    <table>
                        <thead>
                            <tr>
                                <th>المنتج</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>الإجمالي</th>
                                <th>الإجراء</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="products" class="page hidden">
            <h2>إدارة المنتجات</h2>
            <div class="grid split">
                <div class="card">
                    <h3>إضافة / تعديل منتج</h3>
                    <div class="grid">
                        <div class="field">
                            <label>التصنيف</label>
                            <input id="productCategory" placeholder="مثال: إلكترونيات" />
                        </div>
                        <div class="field">
                            <label>اسم المنتج</label>
                            <input id="productName" placeholder="مثال: هاتف ذكي" />
                        </div>
                        <div class="grid cards" style="grid-template-columns: 1fr 1fr">
                             <div class="field">
                                <label>سعر المفرد</label>
                                <input type="number" id="productRetailPrice" value="0" />
                            </div>
                            <div class="field">
                                <label>سعر الجملة</label>
                                <input type="number" id="productWholesalePrice" value="0" />
                            </div>
                        </div>
                        <div class="grid cards" style="grid-template-columns: 1fr 1fr">
                             <div class="field">
                                <label>الكمية</label>
                                <input type="number" id="productQuantity" value="0" />
                            </div>
                            <div class="field">
                                <label>الباركود</label>
                                <input id="productBarcode" placeholder="مثال: 123456789" />
                            </div>
                        </div>
                        <div class="grid cards" style="grid-template-columns: 1fr 1fr">
                             <div class="field">
                                <label>تاريخ الصلاحية</label>
                                <input type="date" id="productExpiryDate" />
                            </div>
                            <div class="field">
                                <label>تاريخ الانتهاء</label>
                                <input type="date" id="productExpirationDate" />
                            </div>
                        </div>
                    </div>
                    <div class="toolbar" style="margin-top: 12px;">
                        <button class="btn primary" id="addProductBtn" onclick="addProduct()"><i class="ti ti-plus"></i> إضافة منتج</button>
                        <button class="btn warn hidden" id="updateProductBtn" onclick="updateProduct()"><i class="ti ti-edit"></i> تعديل</button>
                        <button class="btn ok" onclick="resetForm()"><i class="ti ti-rotate-clockwise"></i> مسح الحقول</button>
                    </div>
                </div>

                <div class="card">
                    <h3>قائمة المنتجات</h3>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table id="productsTable">
                            <thead>
                                <tr>
                                    <th>المنتج</th>
                                    <th>السعر</th>
                                    <th>الكمية</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="sales" class="page hidden">
            <h2>سجل المبيعات</h2>
            <div class="grid cards" style="grid-template-columns: repeat(3, 1fr);">
                <div class="card">
                    <h3>إجمالي المبيعات</h3>
                    <div class="metric" id="totalSalesMetric">0</div>
                    <span class="muted">${db.settings.currency}</span>
                </div>
                <div class="card">
                    <h3>إجمالي الأرباح</h3>
                    <div class="metric" id="totalProfitMetric">0</div>
                    <span class="muted">${db.settings.currency}</span>
                </div>
                <div class="card">
                    <h3>عدد الفواتير</h3>
                    <div class="metric" id="invoiceCountMetric">0</div>
                    <span class="muted">فاتورة</span>
                </div>
            </div>
            <div class="card" style="margin-top: 12px;">
                <div class="toolbar" style="justify-content: flex-end; margin-bottom: 12px;">
                    <button class="btn danger" onclick="clearAllSales()"><i class="ti ti-trash"></i> إفراغ سجل المبيعات</button>
                </div>
                <h3>تفاصيل الفواتير</h3>
                <table id="salesTable">
                    <thead>
                        <tr>
                            <th>رقم الفاتورة</th>
                            <th>العميل</th>
                            <th>الإجمالي</th>
                            <th>الأرباح</th>
                            <th>التاريخ</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div id="expenses" class="page hidden">
            </div>

        <div id="analytics" class="page hidden">
            <h2>تحليلات المبيعات</h2>
            <div class="grid split">
                <div class="card">
                    <h3>المبيعات حسب التصنيف</h3>
                    <canvas id="salesByCategoryChart"></canvas>
                </div>
                <div class="card">
                    <h3>الأرباح حسب التصنيف</h3>
                    <canvas id="profitByCategoryChart"></canvas>
                </div>
            </div>
            <div class="card" style="margin-top: 12px;">
                <h3>أفضل المنتجات مبيعاً</h3>
                <canvas id="topSellingProductsChart"></canvas>
            </div>
        </div>
        
        <div id="barcode" class="page hidden">
            <h2>إضافة منتج بواسطة الباركود</h2>
            <div class="grid split">
                <div class="card">
                    <h3>قراءة الباركود</h3>
                    <div class="grid" style="gap:10px;">
                        <div class="field">
                            <label>رقم الباركود</label>
                            <input id="barcodeInput" type="text" placeholder="امسح الباركود هنا" oninput="populateBarcodeFields(this.value)" />
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>بيانات المنتج</h3>
                    <div class="grid" style="gap:10px;">
                        <div class="field">
                            <label>اسم المنتج</label>
                            <input id="barcodeProductName" placeholder="مثال: هاتف ذكي" />
                        </div>
                        <div class="field">
                            <label>سعر البيع (مفرد)</label>
                            <input id="barcodeRetailPrice" type="number" value="0" />
                        </div>
                        <div class="field">
                            <label>سعر الجملة</label>
                            <input id="barcodeWholesalePrice" type="number" value="0" />
                        </div>
                        <div class="field">
                            <label>الكمية</label>
                            <input id="barcodeQuantity" type="number" value="1" />
                        </div>
                        <div class="field">
                            <label>تاريخ الصلاحية</label>
                            <input id="barcodeExpiryDate" type="date" />
                        </div>
                        <div class="field">
                            <label>تفاصيل المنتج</label>
                            <textarea id="barcodeProductDetails" placeholder="أضف تفاصيل المنتج هنا"></textarea>
                        </div>
                    </div>
                    <div class="toolbar" style="margin-top: 12px;">
                        <button class="btn primary" onclick="addBarcodeProduct()"><i class="ti ti-plus"></i> إضافة المنتج</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="settings" class="page hidden">
            <h2>الإعدادات</h2>
            <div class="grid split">
              <div class="card">
                <h3>إعدادات المتجر</h3>
                <div class="grid" style="gap:10px;">
                  <div class="field">
                      <label>اسم المتجر</label>
                      <input id="storeName" />
                  </div>
                  <div class="field">
                      <label>اسم البائع</label>
                      <input id="salespersonName" />
                  </div>
                  <div class="field">
                      <label>العملة</label>
                      <input id="currency" />
                  </div>
                </div>
                <div class="toolbar" style="margin-top: 12px;">
                    <button class="btn ok" onclick="saveSettings()"><i class="ti ti-device-floppy"></i> حفظ الإعدادات</button>
                </div>
              </div>

              <div class="card">
                <h3>إعدادات الحساب</h3>
                <div class="grid" style="gap:10px;">
                  <div class="field">
                      <label>اسم المستخدم</label>
                      <input id="adminUser" />
                  </div>
                  <div class="field">
                      <label>كلمة السر</label>
                      <input id="adminPass" type="password" />
                  </div>
                </div>
                <div class="toolbar" style="margin-top: 12px;">
                    <button class="btn ok" onclick="saveAccountSettings()"><i class="ti ti-device-floppy"></i> حفظ الحساب</button>
                    <button class="btn warn" onclick="resetLogin()"><i class="ti ti-refresh"></i> إعادة تعيين</button>
                </div>
              </div>
            </div>

            <div class="card" style="margin-top: 12px;">
              <h3>إعدادات المظهر</h3>
              <div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="field">
                  <label>وضع العرض</label>
                  <select id="themeMode" onchange="applyTheme()">
                    <option value="dark">الوضع الليلي</option>
                    <option value="light">الوضع النهاري</option>
                  </select>
                </div>
                <div class="field">
                  <label>موضوع الألوان</label>
                  <select id="themeColor" onchange="applyTheme()">
                    <option value="blue-sky">أزرق سماوي</option>
                    <option value="green-leaf">أخضر ورقي</option>
                    <option value="orange-fire">برتقالي ناري</option>
                  </select>
                </div>
              </div>
              <div class="field" style="margin-top: 10px;">
                <label>نوع الخط</label>
                <select id="themeFont" onchange="applyTheme()">
                  <option value="cairo">القاهرة</option>
                  <option value="almarai">المراعي</option>
                  <option value="amiri">الأميري</option>
                </select>
              </div>
              <div class="field" style="margin-top: 10px;">
                <label>لون الخلفية</label>
                <input type="color" id="backgroundColorPicker" oninput="applyBackgroundColor(this.value)" />
              </div>
            </div>
        </div>
    </div>
  </main>
</div>

<div id="loginPage" class="login">
  <div class="panel">
    <h1>تسجيل الدخول</h1>
    <p class="muted">الافتراضي: admin / admin — يمكنك تغييره من الإعدادات لاحقاً.</p>
    <div class="grid" style="gap:10px; margin-top:12px">
      <div class="field"><label>اسم المستخدم</label><input id="loginUser" placeholder="admin" /></div>
      <div class="field"><label>كلمة السر</label><input id="loginPass" type="password" placeholder="••••••" /></div>
      <div class="toolbar">
        <button class="btn primary" onclick="doLogin()"><i class="ti ti-login"></i> دخول</button>
        <button class="btn warn" onclick="resetLogin()"><i class="ti ti-refresh"></i> إعادة تعيين</button>
      </div>
    </div>
  </div>
</div>

<div id="modal" class="hidden" style="position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.45)">
  <div class="card" style="width:min(720px,94vw)" id="modalBody"></div>
</div>

<script>
  // ====== الإعدادات الافتراضية ======
  const KEY = 'sales-admin-v1';
  const init = {
    settings:{ 
      storeName:'متجر النجمة', 
      salespersonName:'المالك', 
      currency:'IQD', 
      taxRate:0, 
      adminUser:'admin', 
      adminPass:'admin',
      themeMode: 'dark',
      themeColor: 'blue-sky',
      themeFont: 'cairo',
      backgroundColor: null,
      lastIncomeResetDate: null
    },
    products:[], sales:[], expenses:[]
  };
  let db = load();
  let invoiceItems = [];
  let invoiceId = 1;
  let editingProductId = null;

  function load(){ try{ return JSON.parse(localStorage.getItem(KEY)) || init }catch{ return init } }
  function save(){ localStorage.setItem(KEY, JSON.stringify(db)); }
  function byId(id){ return document.getElementById(id) }
  function val(id){ return byId(id).value }
  
  // ====== تحديث الواجهة عند تحميل الصفحة ======
  function renderPage(pageId) {
      document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
      byId(pageId).classList.remove('hidden');
      document.querySelectorAll('.nav button').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
      if (pageId === 'products') {
        renderProductsTable();
      }
      if (pageId === 'sales') {
        renderSalesPage();
      }
      if (pageId === 'settings') {
        renderSettingsPage();
      }
      if (pageId === 'analytics') {
        renderAnalyticsPage();
      }
  }

  document.querySelectorAll('.nav button').forEach(button => {
      button.addEventListener('click', () => {
          renderPage(button.dataset.page);
          toggleSide(false);
      });
  });

  // ====== تسجيل الدخول ======
  const loginState=byId('loginState');
  const loginPage=byId('loginPage');
  function doLogin(){
    const u=val('loginUser').trim();
    const p=val('loginPass').trim();
    if(u===db.settings.adminUser && p===db.settings.adminPass){
      sessionStorage.setItem('logged','1');
      loginPage.style.display='none';
      loginState.textContent='مُسجل';
      renderPage('dashboard');
    } else {
      alert('بيانات الدخول غير صحيحة');
    }
  }
  function logout(){
    if(confirm('هل تريد تسجيل الخروج؟')){
      sessionStorage.removeItem('logged');
      loginPage.style.display='grid';
      loginState.textContent='—';
    }
  }
  (function initLogin(){
    applyTheme();
    applyBackgroundColor(db.settings.backgroundColor);
    if(sessionStorage.getItem('logged')==='1'){
      loginPage.style.display='none';
      loginState.textContent='مُسجل';
      renderPage('dashboard');
    }
    // إنشاء منتجات تجريبية إذا لم تكن موجودة
    if (db.products.length === 0) {
        db.products = [
            { id: '1', name: 'لابتوب', barcode: '123456789', wholesalePrice: 1000, retailPrice: 1200, unit: 'قطعة', details: 'جهاز لابتوب حديث', quantity: 50, category:'إلكترونيات', expiryDate:'2026-12-31', expirationDate:'2028-12-31' },
            { id: '2', name: 'هاتف ذكي', barcode: '987654321', wholesalePrice: 500, retailPrice: 600, unit: 'قطعة', details: 'هاتف ذكي بذاكرة 128GB', quantity: 100, category:'إلكترونيات', expiryDate:'', expirationDate:'' },
            { id: '3', name: 'شاشة', barcode: '1122334455', wholesalePrice: 300, retailPrice: 350, unit: 'قطعة', details: 'شاشة مقاس 24 بوصة', quantity: 75, category:'إلكترونيات', expiryDate:'', expirationDate:'' }
        ];
        save();
    }
    byId('invoiceNumber').value = 'INV-' + Date.now();
    updateIncomeMetrics();
  })();

  function resetLogin(){
    if(confirm('إرجاع اسم المستخدم وكلمة السر إلى admin/admin؟')){
      db.settings.adminUser='admin';
      db.settings.adminPass='admin';
      save();
      alert('تمت إعادة التعيين: admin / admin');
    }
  }

  // ====== فتح/إغلاق الشريط الجانبي ======
  function toggleSide(open){
    const s=byId('sidebar'); const o=byId('overlay');
    if(window.innerWidth>720) return;
    s.classList.toggle('open', !!open);
    o.classList.toggle('hidden', !open);
  }

  // ====== وظائف الفاتورة ======
  function searchProduct(query) {
    const resultsContainer = byId('searchResults');
    resultsContainer.innerHTML = '';
    resultsContainer.classList.add('hidden');

    if (query.trim().length === 0) {
      return;
    }

    const filteredProducts = db.products.filter(p => 
      p.name.includes(query) || (p.barcode && p.barcode.includes(query))
    );
    
    if (filteredProducts.length > 0) {
      resultsContainer.classList.remove('hidden');
      filteredProducts.forEach(product => {
        const resultItem = document.createElement('button');
        resultItem.textContent = `${product.name} (${Math.round(product.retailPrice)} ${db.settings.currency})`;
        resultItem.onclick = () => selectProduct(product.id);
        resultsContainer.appendChild(resultItem);
      });
    }
  }

  function selectProduct(productId) {
    const product = db.products.find(p => p.id === productId);
    if (product) {
      addProductToInvoice(product);
      byId('productSearch').value = '';
      byId('searchResults').innerHTML = '';
      byId('searchResults').classList.add('hidden');
    }
  }

  function addProductToInvoice(product) {
    const existingItem = invoiceItems.find(item => item.id === product.id);
    if (existingItem) {
      existingItem.quantity++;
    } else {
      invoiceItems.push({
        id: product.id,
        name: product.name,
        price: product.retailPrice,
        wholesalePrice: product.wholesalePrice,
        unit: product.unit,
        details: product.details,
        quantity: 1
      });
    }
    renderInvoiceItems();
  }
  
  function updateItemQuantity(productId, newQuantity) {
    const item = invoiceItems.find(item => item.id === productId);
    if (item) {
      item.quantity = parseInt(newQuantity) || 0;
      renderInvoiceItems();
    }
  }

  function removeItemFromInvoice(productId) {
    invoiceItems = invoiceItems.filter(item => item.id !== productId);
    renderInvoiceItems();
  }

  function renderInvoiceItems() {
    const tableBody = byId('invoiceTableBody');
    tableBody.innerHTML = '';
    let total = 0;

    invoiceItems.forEach(item => {
      const itemTotal = item.price * item.quantity;
      total += itemTotal;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.name}</td>
        <td><input type="number" value="${item.quantity}" oninput="updateItemQuantity('${item.id}', this.value)" style="width: 50px; background: none; border: none; text-align: center; color: white;" /></td>
        <td>${Math.round(item.price)} ${db.settings.currency}</td>
        <td>${Math.round(itemTotal)} ${db.settings.currency}</td>
        <td>
          <button class="btn danger" onclick="removeItemFromInvoice('${item.id}')"><i class="ti ti-trash"></i></button>
        </td>
      `;
      tableBody.appendChild(row);
    });

    byId('totalAmount').textContent = Math.round(total);
    updateTotals();
  }

  function updateTotals() {
    const total = parseFloat(byId('totalAmount').textContent) || 0;
    const discount = parseFloat(byId('discount').value) || 0;
    const finalTotal = total - (total * (discount / 100));
    byId('finalTotal').textContent = Math.round(finalTotal);
  }

  function clearInvoice() {
    if (confirm('هل أنت متأكد من إفراغ الفاتورة؟')) {
      invoiceItems = [];
      byId('customerName').value = '';
      byId('invoiceNumber').value = 'INV-' + Date.now();
      byId('discount').value = 0;
      renderInvoiceItems();
    }
  }

  function payAndPrint() {
    if (invoiceItems.length === 0) {
      alert('لا توجد منتجات في الفاتورة لحفظها.');
      return;
    }
    if (confirm('هل تريد إتمام عملية الدفع وطباعة الفاتورة؟')) {
      saveInvoice();
      printInvoice();
      clearInvoice();
    }
  }

  function saveInvoice() {
    // Calculate profit for the invoice
    let profit = 0;
    let finalTotal = parseFloat(byId('finalTotal').textContent);
    invoiceItems.forEach(item => {
      const productData = db.products.find(p => p.id === item.id);
      if (productData) {
        profit += (item.price - productData.wholesalePrice) * item.quantity;
      }
    });
    const invoice = {
      id: byId('invoiceNumber').value,
      customerName: val('customerName') || 'عميل نقدي',
      items: invoiceItems,
      total: finalTotal,
      profit: Math.round(profit),
      date: new Date().toLocaleString()
    };
    db.sales.push(invoice);
    save();
    updateIncomeMetrics();
  }

  function printInvoice() {
      const printContent = `
        <div style="padding: 20px; font-family: 'Cairo', sans-serif; direction: rtl; text-align: right; line-height: 1.6; color: black;">
          <h2 style="text-align: center; color: black;">${db.settings.storeName}</h2>
          <hr style="border-top: 1px dashed black;">
          <p><strong>رقم الفاتورة:</strong> ${byId('invoiceNumber').value}</p>
          <p><strong>اسم العميل:</strong> ${val('customerName') || 'العميل النقدي'}</p>
          <p><strong>اسم البائع:</strong> ${db.settings.salespersonName}</p>
          <p><strong>التاريخ:</strong> ${new Date().toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
          <hr style="border-top: 1px dashed black;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr>
                <th style="border-bottom: 1px solid black; padding: 8px; text-align: right; color: black;">المنتج</th>
                <th style="border-bottom: 1px solid black; padding: 8px; text-align: right; color: black;">الكمية</th>
                <th style="border-bottom: 1px solid black; padding: 8px; text-align: right; color: black;">السعر</th>
                <th style="border-bottom: 1px solid black; padding: 8px; text-align: right; color: black;">الإجمالي</th>
              </tr>
            </thead>
            <tbody>
              ${invoiceItems.map(item => `
                <tr>
                  <td style="padding: 8px; text-align: right; color: black;">${item.name}</td>
                  <td style="padding: 8px; text-align: right; color: black;">${item.quantity}</td>
                  <td style="padding: 8px; text-align: right; color: black;">${Math.round(item.price)} ${db.settings.currency}</td>
                  <td style="padding: 8px; text-align: right; color: black;">${Math.round(item.price * item.quantity)} ${db.settings.currency}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <hr style="border-top: 1px dashed black;">
          <div style="text-align: left;">
            <p style="color: black;"><strong>الإجمالي:</strong> ${byId('totalAmount').textContent} ${db.settings.currency}</p>
            <p style="color: black;"><strong>الخصم:</strong> ${byId('discount').value}%</p>
            <p style="font-size: 1.2em; font-weight: bold; color: black;">الإجمالي النهائي: ${byId('finalTotal').textContent} ${db.settings.currency}</p>
          </div>
          <hr style="border-top: 1px dashed black;">
          <p style="text-align: center; color: black;">شكراً لزيارتكم</p>
        </div>
      `;
      
      const printWindow = window.open('', '_blank', 'height=600,width=800');
      printWindow.document.write('<html><head><title>فاتورة</title>');
      printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">');
      printWindow.document.write('<style>@media print { body { font-family: "Cairo", sans-serif; direction: rtl; text-align: right; } table { width: 100%; border-collapse: collapse; } th, td { border-bottom: 1px solid black; padding: 8px; text-align: right; } }</style>');
      printWindow.document.write('</head><body>');
      printWindow.document.write(printContent);
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
  }


  function globalSearch(){
    const query = byId('globalSearch').value;
    searchProduct(query);
  }

  // ====== وظائف إدارة المنتجات ======
  function renderProductsTable() {
    const tableBody = byId('productsTableBody');
    tableBody.innerHTML = '';
    db.products.forEach(p => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <b>${p.name}</b><br>
                <small>${p.category || 'غير مصنف'}</small>
            </td>
            <td>
                مفرد: ${Math.round(p.retailPrice)} ${db.settings.currency}<br>
                جملة: ${Math.round(p.wholesalePrice)} ${db.settings.currency}
            </td>
            <td>${p.quantity}</td>
            <td>
                <button class="btn ok" onclick="editProduct('${p.id}')"><i class="ti ti-edit"></i></button>
                <button class="btn danger" onclick="deleteProduct('${p.id}')"><i class="ti ti-trash"></i></button>
            </td>
        `;
        tableBody.appendChild(row);
    });
  }

  function addProduct() {
      const newProduct = {
          id: Date.now().toString(),
          category: val('productCategory'),
          name: val('productName'),
          retailPrice: parseFloat(val('productRetailPrice')),
          wholesalePrice: parseFloat(val('productWholesalePrice')),
          quantity: parseInt(val('productQuantity')),
          barcode: val('productBarcode'),
          expiryDate: val('productExpiryDate'),
          expirationDate: val('productExpirationDate')
      };

      if (!newProduct.name || isNaN(newProduct.retailPrice)) {
          alert('يرجى إدخال اسم المنتج وسعر المفرد على الأقل.');
          return;
      }
      db.products.push(newProduct);
      save();
      renderProductsTable();
      resetForm();
      alert('تم إضافة المنتج بنجاح!');
  }

  function editProduct(productId) {
    const product = db.products.find(p => p.id === productId);
    if (product) {
        editingProductId = productId;
        byId('productCategory').value = product.category;
        byId('productName').value = product.name;
        byId('productRetailPrice').value = product.retailPrice;
        byId('productWholesalePrice').value = product.wholesalePrice;
        byId('productQuantity').value = product.quantity;
        byId('productBarcode').value = product.barcode;
        byId('productExpiryDate').value = product.expiryDate;
        byId('productExpirationDate').value = product.expirationDate;

        byId('updateProductBtn').classList.remove('hidden');
        byId('addProductBtn').classList.add('hidden');
    }
  }
  
  function updateProduct() {
      const productIndex = db.products.findIndex(p => p.id === editingProductId);
      if (productIndex > -1) {
          db.products[productIndex] = {
              id: editingProductId,
              category: val('productCategory'),
              name: val('productName'),
              retailPrice: parseFloat(val('productRetailPrice')),
              wholesalePrice: parseFloat(val('productWholesalePrice')),
              quantity: parseInt(val('productQuantity')),
              barcode: val('productBarcode'),
              expiryDate: val('productExpiryDate'),
              expirationDate: val('productExpirationDate')
          };
          save();
          renderProductsTable();
          resetForm();
          alert('تم تعديل المنتج بنجاح!');
      }
  }

  function deleteProduct(productId) {
      if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
          db.products = db.products.filter(p => p.id !== productId);
          save();
          renderProductsTable();
          alert('تم حذف المنتج بنجاح!');
      }
  }

  function resetForm() {
      editingProductId = null;
      byId('productCategory').value = '';
      byId('productName').value = '';
      byId('productRetailPrice').value = 0;
      byId('productWholesalePrice').value = 0;
      byId('productQuantity').value = 0;
      byId('productBarcode').value = '';
      byId('productExpiryDate').value = '';
      byId('productExpirationDate').value = '';

      byId('updateProductBtn').classList.add('hidden');
      byId('addProductBtn').classList.remove('hidden');
  }

  // ====== وظائف صفحة المبيعات ======
  function renderSalesPage() {
    let totalSales = 0;
    let totalProfit = 0;
    const salesTableBody = byId('salesTableBody');
    salesTableBody.innerHTML = '';
    
    db.sales.forEach(sale => {
      totalSales += sale.total;
      totalProfit += parseFloat(sale.profit);
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${sale.id}</td>
        <td>${sale.customerName}</td>
        <td>${Math.round(sale.total)} ${db.settings.currency}</td>
        <td>${Math.round(sale.profit)} ${db.settings.currency}</td>
        <td>${sale.date}</td>
      `;
      salesTableBody.appendChild(row);
    });

    byId('totalSalesMetric').textContent = Math.round(totalSales);
    byId('totalProfitMetric').textContent = Math.round(totalProfit);
    byId('invoiceCountMetric').textContent = db.sales.length;
  }

  function clearAllSales() {
    if (confirm('هل أنت متأكد من إفراغ سجل المبيعات بالكامل؟ لا يمكن التراجع عن هذا الإجراء.')) {
        db.sales = [];
        save();
        renderSalesPage();
        updateIncomeMetrics();
        alert('تم إفراغ سجل المبيعات بنجاح.');
    }
  }


  // ====== وظائف الدخل اليومي والأسبوعي ======
  function updateIncomeMetrics() {
    const today = new Date();
    const todaySales = db.sales.filter(s => new Date(s.date).toDateString() === today.toDateString());
    const dailyIncome = todaySales.reduce((sum, sale) => sum + sale.total, 0);

    const weekStart = new Date(today);
    // Find the previous Monday (or today if it's Monday)
    weekStart.setDate(today.getDate() - (today.getDay() + 6) % 7);
    weekStart.setHours(0, 0, 0, 0);
    
    const weeklySales = db.sales.filter(s => {
        const saleDate = new Date(s.date);
        return saleDate >= weekStart;
    });
    const weeklyIncome = weeklySales.reduce((sum, sale) => sum + sale.total, 0);

    byId('dailyIncomeMetric').textContent = Math.round(dailyIncome);
    byId('weeklyIncomeMetric').textContent = Math.round(weeklyIncome);
    save();
  }

  // ====== وظائف صفحة الإعدادات ======
  function renderSettingsPage() {
      byId('storeName').value = db.settings.storeName;
      byId('salespersonName').value = db.settings.salespersonName;
      byId('currency').value = db.settings.currency;
      byId('adminUser').value = db.settings.adminUser;
      byId('adminPass').value = db.settings.adminPass;
      byId('themeMode').value = db.settings.themeMode;
      byId('themeColor').value = db.settings.themeColor;
      byId('themeFont').value = db.settings.themeFont;
      byId('backgroundColorPicker').value = db.settings.backgroundColor || '#0f172a';
  }

  function saveSettings() {
      db.settings.storeName = val('storeName');
      db.settings.salespersonName = val('salespersonName');
      db.settings.currency = val('currency');
      save();
      alert('تم حفظ إعدادات المتجر بنجاح!');
  }

  function saveAccountSettings() {
      if (confirm('هل أنت متأكد من تغيير بيانات الحساب؟')) {
          db.settings.adminUser = val('adminUser');
          db.settings.adminPass = val('adminPass');
          save();
          alert('تم حفظ بيانات الحساب بنجاح!');
      }
  }

  function applyTheme() {
    db.settings.themeMode = val('themeMode');
    db.settings.themeColor = val('themeColor');
    db.settings.themeFont = val('themeFont');
    save();

    const body = document.body;
    body.classList.remove('theme-light', 'theme-blue-sky', 'theme-green-leaf', 'theme-orange-fire', 'font-cairo', 'font-almarai', 'font-amiri');
    body.classList.add(`theme-${db.settings.themeMode}`, `theme-${db.settings.themeColor}`, `font-${db.settings.themeFont}`);
    
    // Update the gradient for dark mode if needed
    if (db.settings.themeMode === 'dark') {
      body.style.background = 'linear-gradient(135deg,var(--bg),#020617 60%)';
    } else {
      body.style.background = 'var(--bg)';
    }
  }

  function applyBackgroundColor(color) {
      db.settings.backgroundColor = color;
      save();
      document.body.style.setProperty('--custom-bg-color', color);
      document.body.style.background = 'var(--custom-bg-color)';
  }
  
  // ====== وظائف صفحة الباركود الجديدة ======
  function populateBarcodeFields(barcode) {
    const product = db.products.find(p => p.barcode === barcode);
    if (product) {
      alert('تم العثور على منتج بهذا الباركود.');
      byId('barcodeProductName').value = product.name;
      byId('barcodeRetailPrice').value = product.retailPrice;
      byId('barcodeWholesalePrice').value = product.wholesalePrice;
      byId('barcodeQuantity').value = product.quantity;
      byId('barcodeExpiryDate').value = product.expiryDate;
      byId('barcodeProductDetails').value = product.details;
    } else {
      byId('barcodeProductName').value = '';
      byId('barcodeRetailPrice').value = '';
      byId('barcodeWholesalePrice').value = '';
      byId('barcodeQuantity').value = 1;
      byId('barcodeExpiryDate').value = '';
      byId('barcodeProductDetails').value = '';
    }
  }

  function addBarcodeProduct() {
      const barcode = val('barcodeInput').trim();
      if (!barcode) {
          alert('يرجى إدخال رقم الباركود.');
          return;
      }
      
      const existingProduct = db.products.find(p => p.barcode === barcode);
      
      const newProduct = {
          id: existingProduct ? existingProduct.id : Date.now().toString(),
          category: 'تم الإضافة بالباركود',
          name: val('barcodeProductName'),
          retailPrice: parseFloat(val('barcodeRetailPrice')),
          wholesalePrice: parseFloat(val('barcodeWholesalePrice')),
          quantity: parseInt(val('barcodeQuantity')),
          barcode: barcode,
          expiryDate: val('barcodeExpiryDate'),
          expirationDate: val('barcodeExpirationDate') || '' ,
          details: val('barcodeProductDetails')
      };

      if (!newProduct.name || isNaN(newProduct.retailPrice)) {
          alert('يرجى إدخال اسم المنتج وسعر البيع على الأقل.');
          return;
      }

      if (existingProduct) {
          // Update existing product
          Object.assign(existingProduct, newProduct);
          alert('تم تحديث بيانات المنتج بنجاح!');
      } else {
          // Add new product
          db.products.push(newProduct);
          alert('تم إضافة المنتج بنجاح!');
      }

      save();
      // Clear the barcode form after adding/updating
      byId('barcodeInput').value = '';
      byId('barcodeProductName').value = '';
      byId('barcodeRetailPrice').value = '';
      byId('barcodeWholesalePrice').value = '';
      byId('barcodeQuantity').value = 1;
      byId('barcodeExpiryDate').value = '';
      byId('barcodeProductDetails').value = '';
  }

  // ====== وظائف صفحة التحليلات الجديدة ======
  let salesByCategoryChart, profitByCategoryChart, topSellingProductsChart;

  function renderAnalyticsPage() {
    const data = getAnalyticsData();
    renderSalesByCategoryChart(data.salesByCategory);
    renderProfitByCategoryChart(data.profitByCategory);
    renderTopSellingProductsChart(data.topSellingProducts);
  }

  function getAnalyticsData() {
    const salesByCategory = {};
    const profitByCategory = {};
    const productSalesCount = {};
    
    db.sales.forEach(sale => {
        sale.items.forEach(item => {
            const product = db.products.find(p => p.id === item.id);
            if (product) {
                const category = product.category || 'غير مصنف';
                
                // Sales by category
                salesByCategory[category] = (salesByCategory[category] || 0) + (item.price * item.quantity);
                
                // Profit by category
                const itemProfit = (item.price - product.wholesalePrice) * item.quantity;
                profitByCategory[category] = (profitByCategory[category] || 0) + itemProfit;

                // Top selling products
                productSalesCount[product.name] = (productSalesCount[product.name] || 0) + item.quantity;
            }
        });
    });

    // Sort products by sales count
    const sortedProducts = Object.entries(productSalesCount).sort(([, a], [, b]) => b - a).slice(0, 10);
    const topSellingProducts = {
        labels: sortedProducts.map(p => p[0]),
        data: sortedProducts.map(p => p[1])
    };

    return { salesByCategory, profitByCategory, topSellingProducts };
  }

  function renderSalesByCategoryChart(data) {
    const ctx = byId('salesByCategoryChart').getContext('2d');
    if (salesByCategoryChart) { salesByCategoryChart.destroy(); }
    salesByCategoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(data),
            datasets: [{
                data: Object.values(data),
                backgroundColor: [
                    'rgba(34, 211, 238, 0.8)',
                    'rgba(167, 139, 250, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(34, 197, 94, 0.8)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: { display: false }
            }
        }
    });
  }

  function renderProfitByCategoryChart(data) {
    const ctx = byId('profitByCategoryChart').getContext('2d');
    if (profitByCategoryChart) { profitByCategoryChart.destroy(); }
    profitByCategoryChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(data),
            datasets: [{
                label: 'الأرباح',
                data: Object.values(data),
                backgroundColor: 'rgba(34, 197, 94, 0.8)',
                borderColor: 'rgba(34, 197, 94, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
  }

  function renderTopSellingProductsChart(data) {
    const ctx = byId('topSellingProductsChart').getContext('2d');
    if (topSellingProductsChart) { topSellingProductsChart.destroy(); }
    topSellingProductsChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.data,
                backgroundColor: [
                    '#22d3ee', '#a78bfa', '#f59e0b', '#ef4444', '#22c55e', '#6366f1', '#f97316', '#dc2626', '#16a34a', '#ca8a04'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: { display: false }
            }
        }
    });
  }

  document.addEventListener('keydown', (e) => {
    // Check if the barcode input is not focused and a key is pressed (for scanner)
    if (document.activeElement !== byId('barcodeInput')) {
      // Check if a page other than barcode is active
      const barcodePage = byId('barcode');
      if (barcodePage && !barcodePage.classList.contains('hidden')) {
        // Concatenate the key press to the barcode input
        byId('barcodeInput').focus();
        if (e.key === 'Enter') {
          populateBarcodeFields(byId('barcodeInput').value);
        }
      }
    }
  });

</script>
</body>
</html>
